# Filebeat config to collect most Linux logs and ship to Elasticsearch
# Includes:
#  - /var/log/**/*.log (generic)
#  - journald
#  - system module (auth/syslog)
#  - SOC audit + IR reports (from this repo)

filebeat.inputs:
  - type: filestream
    id: varlog_recursive
    enabled: true
    paths:
      - /var/log/**/*.log
      - /var/log/*
    parsers:
      - multiline:
          pattern: '^[A-Za-z]{3} [ 0-9]{2} [0-9:]{8} '
          negate: true
          match: after
    exclude_files: ['.gz$', '.bz2$', '.xz$']
    ignore_older: 72h

  - type: journald
    id: systemd_journal
    enabled: true
    seek: cursor

  - type: filestream
    id: soc_audit
    enabled: true
    paths:
      - {{ lookup('env','SOC_AUDIT_LOG') | default('soc_audit.log', true) | to_json }}
    parsers:
      - ndjson:
          target: ""
          add_error_key: true
    fields:
      event.module: soc
      event.dataset: soc.audit
    fields_under_root: true

  - type: filestream
    id: phishing_reports
    enabled: true
    paths:
      - {{ (playbook_dir | default('.')) + '/../artifacts/phishing/*.json' | to_json }}
    parsers:
      - ndjson:
          target: "phishing"
          add_error_key: true
    fields:
      event.module: soc
      event.dataset: soc.phishing
    fields_under_root: true

  - type: filestream
    id: endpoint_reports
    enabled: true
    paths:
      - {{ (playbook_dir | default('.')) + '/../artifacts/endpoint/*.json' | to_json }}
    parsers:
      - ndjson:
          target: "endpoint"
          add_error_key: true
    fields:
      event.module: soc
      event.dataset: soc.endpoint
    fields_under_root: true

filebeat.modules:
  - module: system
    syslog:
      enabled: true
    auth:
      enabled: true

processors:
  - add_host_metadata: ~
  - add_cloud_metadata: ~
  - decode_json_fields:
      fields: ["message"]
      process_array: true
      max_depth: 3
      target: ""
      overwrite_keys: false
      add_error_key: true
  - rename:
      fields:
        - from: action
          to: event.action
          ignore_missing: true
        - from: host
          to: host.name
          ignore_missing: true
        - from: user
          to: user.name
          ignore_missing: true

output.elasticsearch:
  hosts: ["{{ ES_URL | default('https://es.example.com:9200', true) }}"]
  {% if ES_API_KEY is defined and ES_API_KEY|length > 0 %}
  api_key: "{{ ES_API_KEY }}"
  {% else %}
  username: "{{ ES_USER | default('', true) }}"
  password: "{{ ES_PASS | default('', true) }}"
  {% endif %}
  protocol: https
  ssl:
    verification_mode: full

setup.ilm.enabled: true
setup.template.enabled: true
setup.template.name: "soc-template"
setup.template.pattern: ["soc-*","filebeat-*"]
